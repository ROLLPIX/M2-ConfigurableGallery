<?php
/**
 * Template that injects rollpixGalleryConfig JSON into the product page (PRD ยง6.5).
 * This data is consumed by gallery-switcher.js for color-based gallery filtering.
 *
 * @var \Rollpix\ConfigurableGallery\ViewModel\GalleryData $galleryDataViewModel
 * @var \Magento\Framework\Escaper $escaper
 */

$galleryDataViewModel = $block->getData('gallery_data_view_model');
if (!$galleryDataViewModel || !$galleryDataViewModel->isEnabled()) {
    return;
}

$galleryConfigJson = $galleryDataViewModel->getGalleryConfigJson();

// Get enriched gallery images from the gallery block (includes value_id and associatedAttributes
// injected by EnrichGalleryJson plugin). This makes them available to the swatch-renderer mixin
// before Fotorama initializes, solving the timing issue.
// When Rollpix_ProductGallery is installed, product.info.media.image is removed;
// fallback to the Rollpix gallery block (same Magento\Catalog\Block\Product\View\Gallery class,
// so the EnrichGalleryJson plugin fires on it too).
$galleryBlock = $block->getLayout()->getBlock('product.info.media.image')
    ?: $block->getLayout()->getBlock('rollpix.product.gallery.vertical');
$galleryImagesJson = $galleryBlock ? $galleryBlock->getGalleryImagesJson() : '[]';
?>

<script>
    window.rollpixGalleryConfig = <?= /* @noEscape */ $galleryConfigJson ?>;
    window.rollpixGalleryImages = <?= /* @noEscape */ $galleryImagesJson ?>;
</script>

<script type="text/x-magento-init">
{
    "*": {
        "Rollpix_ConfigurableGallery/js/gallery-init": {
            "galleryConfig": <?= /* @noEscape */ $galleryConfigJson ?>
        }
    }
}
</script>
