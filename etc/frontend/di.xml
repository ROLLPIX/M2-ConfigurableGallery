<?xml version="1.0"?>
<!--
    Frontend-area dependency injection for Rollpix_ConfigurableGallery.
    Registers PLP plugins (PRD §8.7).
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <!-- SEO-friendly color URL router (sortOrder=25, before default at 30) -->
    <type name="Magento\Framework\App\RouterList">
        <arguments>
            <argument name="routerList" xsi:type="array">
                <item name="rollpix_color_seo" xsi:type="array">
                    <item name="class" xsi:type="string">Rollpix\ConfigurableGallery\Router\ColorRouter</item>
                    <item name="sortOrder" xsi:type="string">25</item>
                </item>
            </argument>
        </arguments>
    </type>

    <!--
        PLP: Change product thumbnail when swatch is selected.
        sortOrder=10: base PLP swatch plugin.
    -->
    <type name="Magento\Swatches\Helper\Data">
        <plugin name="rollpix_cg_plp_swatch_image"
                type="Rollpix\ConfigurableGallery\Plugin\Plp\SwatchImagePlugin"
                sortOrder="10"/>
    </type>

    <!--
        PLP Compat: HoverSlider — filter slider images by color.
        sortOrder=20: runs after HoverSlider's afterToHtml (sortOrder=10).
        Always registered but checks ModuleManager::isEnabled('Rollpix_HoverSlider') internally.
    -->
    <type name="Magento\Catalog\Block\Product\Image">
        <plugin name="rollpix_cg_plp_hoverslider_compat"
                type="Rollpix\ConfigurableGallery\Plugin\Plp\HoverSliderCompatPlugin"
                sortOrder="20"/>
    </type>

    <!--
        PLP Compat: ImageFlipHover — update flip image by color.
        sortOrder=110: runs after ImageFlipHover's afterToHtml (sortOrder=100).
        Always registered but checks ModuleManager::isEnabled('Rollpix_ImageFlipHover') internally.
    -->
    <type name="Magento\Catalog\Block\Product\Image">
        <plugin name="rollpix_cg_plp_imageflip_compat"
                type="Rollpix\ConfigurableGallery\Plugin\Plp\ImageFlipCompatPlugin"
                sortOrder="110"/>
    </type>

    <!--
        Plugin: Override cart/checkout item image with color-specific image.
        Hooks into ItemProductResolver::getFinalProduct() — the universal point
        where Magento decides which product image to render for configurable items
        in cart page, minicart, and checkout (works with Luma & Hyva).
        sortOrder=10: base plugin, no expected conflicts.
    -->
    <type name="Magento\ConfigurableProduct\Model\Product\Configuration\Item\ItemProductResolver">
        <plugin name="rollpix_cg_cart_item_image"
                type="Rollpix\ConfigurableGallery\Plugin\CartItemImagePlugin"
                sortOrder="10"/>
    </type>
</config>
